# Test Configuration

# =============================================================================
# Database Configuration for Tests
# =============================================================================
# Use PostgreSQL devservice (provided by Quarkus TestContainers)
quarkus.datasource.db-kind=postgresql
quarkus.datasource.devservices.enabled=true

# Flyway configuration
quarkus.flyway.migrate-at-start=true
quarkus.flyway.locations=db/migration
quarkus.flyway.clean-at-start=true

# Hibernate: validate schema against entities
quarkus.hibernate-orm.database.generation=none

# =============================================================================
# Auth Mode Configuration
# =============================================================================
# Mode: "embedded" (full IdP) or "remote" (token validation only)
flowcatalyst.auth.mode=embedded

# JWT configuration
flowcatalyst.auth.jwt.issuer=flowcatalyst
flowcatalyst.auth.jwt.access-token-expiry=PT1H
flowcatalyst.auth.jwt.session-token-expiry=PT8H
flowcatalyst.auth.jwt.refresh-token-expiry=P30D
flowcatalyst.auth.jwt.authorization-code-expiry=PT10M

# Session cookie settings (test mode - not secure for localhost)
flowcatalyst.auth.session.secure=false
flowcatalyst.auth.session.same-site=Lax
flowcatalyst.auth.session.cookie-name=FLOWCATALYST_SESSION

# PKCE settings
flowcatalyst.auth.pkce.required=true

# Remote IdP settings (not used in embedded mode, but needed for config mapping)
flowcatalyst.auth.remote.jwks-cache-duration=PT1H

# IDP Configuration for tests
flowcatalyst.idp.anchor.enabled=false
flowcatalyst.idp.anchor.type=KEYCLOAK
flowcatalyst.idp.platform.enabled=false
flowcatalyst.idp.platform.type=KEYCLOAK

# JWT Configuration for tests (SmallRye JWT)
mp.jwt.verify.issuer=flowcatalyst

# Disable SmallRye JWT's default token parsing - we use our own InternalIdentityProvider
# This prevents SmallRye from trying to load JWKS from a URL during startup
# Setting to classpath:publicKey.pem but our InternalIdentityProvider doesn't use this
smallrye.jwt.verify.key-format=JWK
quarkus.smallrye-jwt.enabled=false

# Hibernate ORM - JSON column handling for tests
quarkus.hibernate-orm.mapping.format.global=ignore

# =============================================================================
# HTTP Auth Permissions for Tests
# =============================================================================
# Admin endpoints handle their own authentication via JwtKeyService
quarkus.http.auth.permission.admin-api.paths=/api/admin/*
quarkus.http.auth.permission.admin-api.policy=permit

# Auth endpoints must be public
quarkus.http.auth.permission.auth-public.paths=/auth/*,/oauth/*,/.well-known/*
quarkus.http.auth.permission.auth-public.policy=permit
