# Quarkus Configuration

# =============================================================================
# Auth Mode Configuration
# =============================================================================
# Mode: "embedded" (full IdP) or "remote" (token validation only)
flowcatalyst.auth.mode=${FLOWCATALYST_AUTH_MODE:embedded}

# Remote mode settings (when mode=remote)
flowcatalyst.auth.remote.issuer=${FLOWCATALYST_AUTH_REMOTE_ISSUER:}
flowcatalyst.auth.remote.jwks-url=${FLOWCATALYST_AUTH_REMOTE_JWKS_URL:}
flowcatalyst.auth.remote.login-url=${FLOWCATALYST_AUTH_REMOTE_LOGIN_URL:}
flowcatalyst.auth.remote.logout-url=${FLOWCATALYST_AUTH_REMOTE_LOGOUT_URL:}
flowcatalyst.auth.remote.platform-url=${FLOWCATALYST_AUTH_REMOTE_PLATFORM_URL:}
flowcatalyst.auth.remote.jwks-cache-duration=${FLOWCATALYST_AUTH_REMOTE_JWKS_CACHE:PT1H}

# =============================================================================
# Bean Configuration
# =============================================================================

# Enable bean archive index at runtime for permission/role scanning
quarkus.arc.remove-unused-beans=false
quarkus.index-dependency.jandex.group-id=org.jboss
quarkus.index-dependency.jandex.artifact-id=jandex

# Always index all classes for annotation scanning
quarkus.index-dependency.backend.group-id=tech.flowcatalyst
quarkus.index-dependency.backend.artifact-id=flowcatalyst-backend
quarkus.index-dependency.platform.group-id=tech.flowcatalyst
quarkus.index-dependency.platform.artifact-id=flowcatalyst-platform

# Register config mappings from library modules
smallrye.config.mapping.validate-unknown=false

# Hibernate ORM - JSON column handling
# We use JSONB columns in the database but don't need Quarkus' REST JSON formatting
quarkus.hibernate-orm.mapping.format.global=ignore

# =============================================================================
# JWT / Internal Authentication Configuration
# =============================================================================

# JWT issuer (appears in 'iss' claim)
flowcatalyst.auth.jwt.issuer=${FLOWCATALYST_JWT_ISSUER:flowcatalyst}

# JWT key paths (optional - if not set, keys are auto-generated on startup)
# For production, generate keys and configure these paths:
#   openssl genrsa -out jwt-private.pem 2048
#   openssl rsa -in jwt-private.pem -pubout -out jwt-public.pem
flowcatalyst.auth.jwt.private-key-path=${FLOWCATALYST_JWT_PRIVATE_KEY_PATH:}
flowcatalyst.auth.jwt.public-key-path=${FLOWCATALYST_JWT_PUBLIC_KEY_PATH:}

# Token expiry durations (ISO-8601 duration format)
flowcatalyst.auth.jwt.access-token-expiry=${FLOWCATALYST_ACCESS_TOKEN_EXPIRY:PT1H}
flowcatalyst.auth.jwt.session-token-expiry=${FLOWCATALYST_SESSION_TOKEN_EXPIRY:PT8H}
flowcatalyst.auth.jwt.refresh-token-expiry=${FLOWCATALYST_REFRESH_TOKEN_EXPIRY:P30D}
flowcatalyst.auth.jwt.authorization-code-expiry=${FLOWCATALYST_AUTH_CODE_EXPIRY:PT10M}

# Session cookie settings
flowcatalyst.auth.session.secure=${FLOWCATALYST_SESSION_SECURE:true}
flowcatalyst.auth.session.same-site=${FLOWCATALYST_SESSION_SAME_SITE:Strict}
flowcatalyst.auth.session.cookie-name=${FLOWCATALYST_SESSION_COOKIE:FLOWCATALYST_SESSION}

# PKCE settings (for OAuth2 authorization code flow)
flowcatalyst.auth.pkce.required=${FLOWCATALYST_PKCE_REQUIRED:true}

# Dev profile - less secure cookies for localhost
%dev.flowcatalyst.auth.session.secure=false

# =============================================================================
# SmallRye JWT Configuration (for token verification)
# =============================================================================

# Accept tokens from our own issuer
mp.jwt.verify.issuer=${flowcatalyst.auth.jwt.issuer}

# JWKS URL for token verification (points to our own endpoint)
# In production, set the full URL including hostname
mp.jwt.verify.publickey.location=${FLOWCATALYST_JWKS_URL:http://localhost:8080/.well-known/jwks.json}

# Token can come from cookie or Authorization header
mp.jwt.token.cookie=FLOWCATALYST_SESSION
mp.jwt.token.header=Authorization

# =============================================================================
# HTTP Auth Permissions (public endpoints)
# =============================================================================

# Auth endpoints must be public (login, token, discovery)
quarkus.http.auth.permission.auth-public.paths=/auth/login,/auth/check-domain,/oauth/token,/.well-known/*
quarkus.http.auth.permission.auth-public.policy=permit

# Health endpoints public
quarkus.http.auth.permission.health-public.paths=/q/health/*,/health/*
quarkus.http.auth.permission.health-public.policy=permit

# =============================================================================
# Database Configuration
# =============================================================================

# Production database settings (override via environment variables)
quarkus.datasource.db-kind=postgresql
quarkus.datasource.username=${POSTGRES_USER:flowcatalyst}
quarkus.datasource.password=${POSTGRES_PASSWORD:flowcatalyst}
quarkus.datasource.jdbc.url=${POSTGRES_URL:jdbc:postgresql://localhost:5432/flowcatalyst}

# Dev profile - use docker-compose postgres, disable Dev Services
%dev.quarkus.hibernate-orm.schema-management.strategy=update
%dev.quarkus.datasource.devservices.enabled=false
%dev.quarkus.log.console.json=false
%dev.quarkus.datasource.jdbc.url=jdbc:postgresql://localhost:5432/flowcatalyst
%dev.quarkus.datasource.username=flowcatalyst
%dev.quarkus.datasource.password=flowcatalyst

# Disable all Quarkus Dev Services (use docker-compose instead)
%dev.quarkus.devservices.enabled=false


# =============================================================================
# IDP Configuration (Identity Provider)
# =============================================================================

# Anchor IDP (for anchor domain users)
flowcatalyst.idp.anchor.enabled=${IDP_ANCHOR_ENABLED:false}
flowcatalyst.idp.anchor.type=${IDP_ANCHOR_TYPE:KEYCLOAK}

# Platform IDP (for platform-managed users)
flowcatalyst.idp.platform.enabled=${IDP_PLATFORM_ENABLED:false}
flowcatalyst.idp.platform.type=${IDP_PLATFORM_TYPE:KEYCLOAK}
